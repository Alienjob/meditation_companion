# Project Compliance Review – 2025-09-30

## Summary
- Model conventions are not yet met; several core models carry logic, dynamic constructors, or persistence helpers that the docs forbid.
- Voice streaming specs (implementation + tests) remain largely unimplemented, so the assistant flow will break when the AudioService receives real audio.
- Authentication and the broader BLoC architecture align with the documented patterns and have solid test coverage.
- Environment/setup guidance is only partially followed; secrets documentation and template files called out in the docs are missing.
- Core progress tracking has the right building blocks (queue, Supabase service), but anonymous session handling violates the documented schema constraints.

## Detailed Findings

### docs/code_conventions/models.md
- **Status:** Not met — `MeditationSession` keeps validation, non-const factories, and a `Uuid` dependency inside the model, breaching the “immutable, const, model-only deps” rule (`app/lib/features/meditation/models/meditation_session.dart:16`, `app/lib/features/meditation/models/meditation_session.dart:60`).
- **Issue:** `ChatMessage` embeds JSON conversion helpers that should live in repositories per the doc’s separation guidance (`app/lib/features/chat/models/chat_message.dart:37`, `app/lib/features/chat/models/chat_message.dart:47`).
- **Issue:** Analytics event factories generate timestamps internally (`app/lib/features/analytics/models/analytics_event.dart:55`), leaving date math inside models instead of higher layers as recommended.
- **Positive:** The auth `User` model follows the prescribed pattern (const ctor, Equatable, no side effects) (`app/lib/features/auth/models/user_model.dart:3`).

### docs/code_conventions/state_management.md
- **Status:** Largely met — Auth and meditation blocs wire events/states with Equatable and single responsibility as described (`app/lib/features/auth/bloc/auth_bloc.dart:12`, `app/lib/features/meditation/bloc/meditation_bloc.dart:24`).
- **Positive:** ChatBloc mirrors the documented event/state naming and repository delegation (`app/lib/features/chat/bloc/chat_bloc.dart:8`).
- **Gap:** The shared `BlocObserver` hook the doc recommends is absent, so cross-bloc diagnostics are harder than outlined (no equivalent setup in `app/lib/main.dart`).

### docs/code_conventions/testing_strategy.md
- **Status:** Partial — unit and widget tests exist for auth/meditation (e.g. `app/test/features/meditation/models/meditation_session_test.dart:1`, `app/test/widget/meditation/meditation_session_screen_test.dart:1`), but the new voice-streaming surface has no unit coverage.
- **Issue:** The documented dependency list still calls for `mockito`, yet the project swapped to `mocktail` without updating the guide (`app/pubspec.yaml:24`).
- **Gap:** No tests exercise the new AudioService voice methods, because those methods still throw `UnimplementedError` (`app/lib/features/meditation/services/mock_audio_service.dart:69`, `app/lib/features/meditation/services/real_audio_service.dart:163`).

### docs/code_conventions/new_feature_implementation.md
- **Status:** Partial — the feature tree generally matches the sample, but there is no `lib/features/meditation/repository` folder even though the doc’s template requires it.
- **Issue:** Voice assistant scaffolding leaves `real_audio_recorder.dart` empty, so the “write tests → build impl” loop stops mid-way (`app/lib/features/voice_assistant/services/real_audio_recorder.dart:1`).
- **Positive:** Meditation feature tests do exist before/alongside implementation (`app/test/features/meditation/bloc/meditation_bloc_test.dart:1`).

### docs/setup/environment.md
- **Status:** Partial — launch.json uses the Command Variable extension as described (`.vscode/launch.json:5`), but the repo lacks the documented `.vscode/launch.variables.template.json` and `.vscode/launch.variables.json` pair.
- **Issue:** The secrets folder only contains `secrets/secrets.json`; the required `secrets/secrets.md` reference file is missing.
- **Gap:** The doc emphasises keeping all env documentation versioned; no guidance file exists to explain the additional OPENAI key used in `EnvConfig` (`app/lib/config/env_config.dart:3`).

### docs/mvp/1 - User Authentication Setup.md
- **Status:** Met — abstract repository, mock, and Supabase implementations are in place with the expected flows (`app/lib/features/auth/repository/auth_repository.dart:1`, `app/lib/features/auth/repository/supabase_auth_repository.dart:1`).
- **Positive:** AuthBloc covers sign-in/out/reset states and is fully unit-tested (`app/lib/features/auth/bloc/auth_bloc.dart:12`, `app/test/features/auth/bloc/auth_bloc_test.dart:1`).
- **Gap:** Secrets handling for Supabase is ready, but the doc’s instruction to keep setup docs alongside the secrets file is not yet fulfilled (see setup findings above).

### docs/mvp/2 - Basic Meditation Tools.md
- **Status:** Partial — timer and ambient audio services exist with tests (`app/lib/features/meditation/services/real_timer_service.dart:1`, `app/test/features/meditation/services/mock_audio_service_test.dart:1`), yet the spec’s repository layer and UI file naming aren’t implemented (`lib/features/meditation/repository` missing, UI concentrated in `meditation_session_screen.dart`).
- **Issue:** Voice streaming support (timer + audio integration checkpoints) is unfinished; `AudioService.appendVoiceChunk/stopVoice/voiceStreamState` still throw (`app/lib/features/meditation/services/real_audio_service.dart:163`).
- **Gap:** The plan’s ambient mixer UI components (`timer_controls.dart`, `sound_mixer_controls.dart`) were not created; functionality lives in composite widgets instead (`app/lib/features/meditation/widgets`).

### docs/mvp/3 - Core Progress Tracking.md
- **Status:** Partial — event queue + Supabase analytics service match the offline/queue requirements (`app/lib/features/analytics/models/event_queue.dart:57`, `app/lib/features/analytics/services/supabase_analytics_service.dart:82`).
- **Issue:** Anonymous sessions violate the schema; `startSession` fabricates a UUID for `user_id`, but the migration requires that ID to exist in `auth.users` (`app/lib/features/analytics/services/supabase_analytics_service.dart:93`).
- **Gap:** Domain models such as `AppSession` and specific event classes from the spec are absent; everything funnels through a generic `AnalyticsEvent` (`app/lib/features/analytics/models/analytics_event.dart:4`).

### docs/chat and voice streaming support.md
- **Status:** Not met — the AudioService voice pipeline is unimplemented (`app/lib/features/meditation/services/real_audio_service.dart:163`), so the assistant cannot play or stop streamed audio.
- **Issue:** `AssistantBloc` never forwards transcripts to `ChatBloc`; `_onUserMessageTranscribed` is empty, leaving chat updates to happen elsewhere contrary to the doc’s flow (`app/lib/features/voice_assistant/bloc/assistant_bloc.dart:172`).
- **Issue:** `VoiceStreamState` is never emitted because both real and mock services throw for that getter (`app/lib/features/meditation/services/mock_audio_service.dart:81`).
- **Gap:** Position tracking pauses are never surfaced; no consumer calls `setPausedState`, so buffering isn’t reported to the tracker (`app/lib/features/audio/services/stream_timeline.dart:35`, `app/lib/features/voice_assistant/bloc/assistant_bloc.dart:188`).

### docs/chat and voice streaming tests.md
- **Status:** Not met — there are no tests covering the new voice streaming states or AudioService methods referenced in the doc; the methods still throw as noted above.
- **Gap:** Bloc tests mock `AudioService` rather than exercising state transitions through `voiceStreamState`, so the required cases (`should_handle_initial_chunk`, etc.) are missing (`app/test/features/voice_assistant/bloc/assistant_bloc_test.dart:92`).

### docs/audio streaming position tracking.md
- **Status:** Partial — the `StreamTimeline` helper and its unit tests exist (`app/lib/features/audio/services/stream_timeline.dart:5`, `app/test/unit/audio/services/stream_timeline_test.dart:6`).
- **Issue:** The tracker never records a start timestamp; if `getInterruptionState` is called only once (as in `_onInterruptResponse`), `_accumulatedTimeMs` stays zero and the assistant will always report 0 samples (`app/lib/features/audio/services/stream_timeline.dart:40`, `app/lib/features/voice_assistant/bloc/assistant_bloc.dart:206`).
- **Issue:** Real audio playback never signals pause/resume to the tracker, so the pause-handling branch the doc highlights cannot work (`app/lib/features/audio/services/stream_timeline.dart:35`).

### docs/roadmap.md (informational)
- No action required; the implementation gaps noted above align with roadmap phases still marked as future work.

## Recommendations
- Implement the voice streaming pipeline end-to-end in `RealAudioService` (chunk buffering, SoLoud stream setup, voice state stream) and add the missing unit tests before enabling the assistant flow.
- Refactor models (`MeditationSession`, analytics events, chat messages) to move runtime logic into blocs/repositories and adopt const constructors per the conventions.
- Introduce the missing meditation repository layer and UI structure, or update the docs to reflect the new architecture if that deviation is intentional.
- Resolve analytics session handling for anonymous users by storing events under a real Supabase user or updating the schema/docs; add the documented `AppSession` model for clarity.
- Backfill environment documentation (`secrets/secrets.md`, launch templates) so new contributors can follow the prescribed setup without guesswork.
